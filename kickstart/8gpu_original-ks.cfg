#Generated by Kickstart Configurator
#platform=x86, AMD64, or Intel EM64T

#System  language
lang en_US
#Language modules to install
#langsupport en_US
#System keyboard
keyboard us
#Sytem timezone
timezone Asia/Seoul
#Root password
rootpw --iscrypted $6$2OAak6LrJoUr3Srf$ugbMlE0am3U0U6Q.5NySLM0pGfewXM6QMiRjxaAKrS/Ox4Yk.t6yapYodaQyWV90gYGSez5YnrCabSDWIQ8p4.
# SELinux configuration
selinux --disabled
#Reboot after installation
reboot
#Use text mode install
text
#Use NFS installation Media
nfs --server=202.20.169.251  --dir=/opt/clmgr/repos/distro/rhel8.3.0-x86_64
repo --name HPCM --baseurl http://202.20.169.251/repo/opt/clmgr/repos/cm/Cluster-Manager-1.5-rhel83-x86_64
#System bootloader configuration
bootloader --location=mbr --boot-drive=sda --append="rd.driver.blacklist=nouveau nouveau.modeset=0"
#Clear the Master Boot Record
zerombr
#Partition clearing information
clearpart --all --initlabel 
#Disk partitioning information
part /boot/efi --fstype="efi" --ondisk=sda --size=1024 --fsoptions="umask=0077,shortname=winnt" --ondisk sda
part /boot --fstype ext4 --size 1024 --ondisk sda
part swap --size 32768 --ondisk sda
part / --fstype ext4 --size 1 --grow --ondisk sda
#Network information
network --bootproto=static --device=88:e9:a4:20:30:4e --gateway=202.20.169.254 --ip=202.20.169.1 --netmask=255.255.255.0 --onboot=on --hostname agpu1301
#Firewall configuration
firewall --disabled 
#Do not configure XWindows
skipx
#Package install information
%packages
# nfs-utils needed for pre and post logging
nfs-utils
# optional packages
@^graphical-server-environment
@container-management
@debugging
@development
@dotnet-core
@file-server
@ftp-server
@graphical-admin-tools
@guest-agents
@headless-management
@infiniband
@legacy-unix
@network-file-system-client
@network-server
@performance
@remote-desktop-clients
@remote-system-management
@rpm-development-tools
@scientific
@security-tools
@smb-server
@system-tools
@web-server
numactl
numactl-devel
kexec-tools
pciutils
gcc
gcc-c++
glibc
glibc-common
glibc-devel
glibc-headers
kernel-headers
tk
lsof
pkgconf-pkg-config
kernel-modules-extra
rsync
make
openssl-devel
# for diskless
net-tools
tftp
bind-utils
libmlx4
# for customer
chrony
openssh-server
util-linux
wget
python36
yum-utils
ksh
lapack
hwloc
sysstat
dstat
tar
bzip2
perl-interpreter
ipmitool
net-snmp
net-snmp-utils
net-snmp-libs
net-snmp-agent-libs
ksh
tcsh
psacct
m4
binutils
cpp
tcl
libgfortran
libquadmath
libquadmath-devel
libusbx
libstdc++-devel
zlib-devel
gtk2
fuse-libs
libyaml
elfutils-libelf-devel
gcc-gfortran
#libyaml-devel
environment-modules
cmu_cn
cattr
cattr-tempo
clusterhealth-server
cm-cli
cm-pdsh
cm-pdsh-mod-genders
cm-pdsh-rcmd-exec
cm-pdsh-rcmd-ssh
collectl
cm_rest_lib
crepo-libs
filebeat
fping
ganglia-gmond
genders
hpe-build-key
libganglia
libgenders
memlog
oscar-base
oscar-base-OCA
pigz
sgi-cluster
sgi-cm-agnostic
sgi-csn
sgi-devname
sgi-pysnmp
sgi-service-node
sgi-service-node-release
sgi-settings
sgi-support-tools
sgi-tarem
ssh-oscar
systemimager-client
tempohb-client
udpcast
yume
perl-XML-LibXML
%end
%pre
#CMU_LOG_INFO_START
#FOR CMU usage only do not put anything between START and STOP
mkdir -p /tmp/cmulogmount
mount -t nfs -o nolock 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
mount -t nfs -o remount,rw 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
echo "PRE_START" >> /tmp/cmulogmount/agpu1301.log
umount /tmp/cmulogmount
#CMU_LOG_INFO_STOP
#CMU_LOG_INFO_START
#FOR CMU usage only do not put anything between START and STOP
mkdir -p /tmp/cmulogmount
mount -t nfs -o nolock 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
mount -t nfs -o remount,rw 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
echo "PRE_STOP" >> /tmp/cmulogmount/agpu1301.log
umount /tmp/cmulogmount
#CMU_LOG_INFO_STOP
%end
%post --interpreter=/bin/bash --log=/root/ks-post.log 
#CMU_LOG_INFO_START
#FOR CMU usage only do not put anything between START and STOP
mkdir -p /tmp/cmulogmount
mount -t nfs -o nolock 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
mount -t nfs -o remount,rw 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
echo "POST_START" >> /tmp/cmulogmount/agpu1301.log
mkdir -p /etc/opt/sgi/
cp -f /tmp/cmulogmount/cminfo-agpu1301 /etc/opt/sgi/cminfo
umount /tmp/cmulogmount
#CMU_LOG_INFO_STOP
echo 202.20.169.251 hpcm1 admin >> /etc/hosts
echo 202.20.169.1 agpu1301 >> /etc/hosts
echo agpu1301 >> /etc/HOSTNAME
###since rh6
grep -v HOSTNAME /etc/sysconfig/network > /tmp/tempo_file_mine
echo "HOSTNAME=agpu1301" >> /tmp/tempo_file_mine
mv /etc/sysconfig/network /etc/sysconfig/network.orig
cp /tmp/tempo_file_mine /etc/sysconfig/network

########################################
## Global Environment
#########################################
KS_SERVER=admin
KS_SERVER_IP=202.20.169.251

IP=""
HOSTNAME=""

WORK_DIR=/install

CFG_DIR=${WORK_DIR}/post/post_config
PKG_DIR=${WORK_DIR}/post/post_packages
OFED_PDIR=${PKG_DIR}/ofed
GPU_PDIR=${PKG_DIR}/cuda

########################################
# To Mount for work directory
########################################
function init_work_dir() {
        mkdir -p ${WORK_DIR}
        # -o nolock is required in Kickstart %post section
        mount -t nfs -o nolock ${KS_SERVER_IP}:${WORK_DIR} ${WORK_DIR}
}

########################################
# Setup IB Address
########################################
function setup_ib() {

                if [ -d ${OFED_PDIR} ]; then
                        cd ${OFED_PDIR}
                        ./mlnxofedinstall --hpc --force --without-fw-update
                fi

                IB=ib0
                IB_IP=`cat ${CFG_DIR}/ibhosts|grep -w agpu1301-ib |awk '{print $2}'`

cat << EOF > /etc/sysconfig/network-scripts/ifcfg-ib0
DEVICE=${IB}
TYPE=Infiniband
NM_CONTROLLED=yes
BOOTPROTO=none
IPADDR=${IB_IP}
NETMASK=255.255.0.0
ONBOOT=yes
EOF
}

########################################
# Setup GPU Driver
########################################
function setup_gpu() {

                if [ -d ${GPU_PDIR} ]; then
                        cd ${GPU_PDIR}
                        ./NVIDIA-Linux-x86_64-460.73.01.run --no-opengl-files -s
			dnf install -y nvidia-fabricmanager-460.x86_64
			systemctl enable nvidia-fabricmanager.service
			systemctl enable NetworkManager.service
			systemctl start nvidia-fabricmanager.service
			systemctl start NetworkManager.service
                fi
}

########################################
# Setup YUM
########################################
function setup_yum() {
                rm -rf /etc/yum.repos.d/*

                # RHEL8 repository
		wget -P /etc/yum.repos.d http://202.20.187.241/rhel8.3_iso/rhel8.3_iso.repo
		wget -P /etc/yum.repos.d http://202.20.187.241/epelrepo_rhel8/epel/epel-rhel8.repo
		wget -P /etc/yum.repos.d http://202.20.187.241/MLNX_OFED/5.2-1.0.4.0-rhel8.3.repo
		wget -P /etc/yum.repos.d http://202.20.187.241/linux/centos/docker-ce.repo
		wget -P /etc/yum.repos.d http://202.20.187.241/cudarepo_rhel8/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
}

########################################
# Setup SSH & PIP
########################################
function setup_sshpip() {
		cp -au ${CFG_DIR}/.ssh /root/
		cp -au ${CFG_DIR}/.pip /root/
}

########################################
# Setup SAIT Configuration
########################################
function setup_sait() {
		dnf install -y htop
		dnf install -y iftop
		## sysstat
		systemctl enable sysstat
		## NVPEERMEM
	        wget -P ./ http://202.20.187.241/cudarepo_rhel8/nvidia_peer_memory-1.1-0.x86_64.rpm
        	dnf -y install ./nvidia_peer_memory-1.1-0.x86_64.rpm
        	systemctl start nv_peer_mem.service
        	systemctl enable nv_peer_mem.service
        	systemctl status nv_peer_mem.service
		## LDAP
		cp -au ${CFG_DIR}/ldap.conf /etc/openldap/ldap.conf
		cp -au ${CFG_DIR}/sssd.conf /etc/sssd/sssd.conf
		#\cp -avf ${CFG_DIR}/nsswitch.conf /etc/nsswitch.conf
		yes | cp -avf ${CFG_DIR}/nsswitch.conf /etc/nsswitch.conf
	        chmod 600 /etc/sssd/sssd.conf
        	chown root:root /etc/sssd/sssd.conf
        	openssl rehash /etc/openldap/certs
        	authselect select sssd with-mkhomedir --force
        	systemctl enable --now oddjobd.service
		systemctl start sssd.service
        	systemctl enable sssd.service
        	systemctl start oddjobd.service
        	systemctl enable oddjobd.service
		## DOCKER
		dnf -y erase runc
        	dnf -y install docker-ce-19.03.15 docker-ce-cli-19.03.15
	        #local docker group delet
	        sed -i 's/docker.*/docker:x:971:/g' /etc/group
		systemctl --now enable docker
		## NTP
		systemctl enable chronyd
		cp -au ${CFG_DIR}/chrony.conf /etc/chrony.conf
		systemctl restart chronyd.service
		## LSF
		dnf -y install libnsl
		cp -au ${CFG_DIR}/lsf.sh /etc/profile.d/lsf.sh
		cp -au ${CFG_DIR}/lsf.csh /etc/profile.d/lsf.csh
		## RUNLEVEL
		systemctl set-default multi-user.target
		## NVIDIA PERSISTENCE MODE
		systemctl start nvidia-persistenced.service
        	systemctl enable nvidia-persistenced.service
}


init_work_dir
setup_ib
setup_yum
setup_gpu
setup_sshpip
setup_sait

###rhel7 specific: set NIC pxe boot option at the top of UEFI boot order list
###based on the cmuserver.conf settings
if [ "no" == "yes" ] ; then
    curr_nw_boot=`efibootmgr | grep "BootCurrent:" | awk '{print $2}'`
    curr_boot_order=`efibootmgr | grep "BootOrder:" | awk '{print $2}'`
    curr_boot_order=`echo "${curr_boot_order}" | sed -e 's/'"${curr_nw_boot}"',*//g'`
    new_boot_order=`echo "${curr_nw_boot},${curr_boot_order}"  | sed -e 's/,$//g' ` 
    if [ ! -z "$new_boot_order" ] ; then
        efibootmgr -o ${new_boot_order}
    fi
fi

#CMU_LOG_INFO_START
#FOR CMU usage only do not put anything between START and STOP
mkdir -p /tmp/cmulogmount
mount -t nfs -o nolock 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
mount -t nfs -o remount,rw 202.20.169.251:/opt/clmgr/image/autoGPU/ /tmp/cmulogmount
echo "POST_STOP" >> /tmp/cmulogmount/agpu1301.log
umount /tmp/cmulogmount
#CMU_LOG_INFO_STOP
%end
